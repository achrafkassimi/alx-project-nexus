{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <div class="row">
    <!-- Sidebar: Users List -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5>ğŸ“œ Users</h5>
        </div>
        <ul class="list-group list-group-flush">
          {% for user in users %}
          <a href="{% url 'chat_with_user' user.id %}"
             class="list-group-item list-group-item-action {% if user.id == other_user.id %}active{% endif %}">
            {{ user.username }}
          </a>
        {% endfor %}
        
        </ul>
      </div>
    </div>

    <!-- Chat Interface -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4>ğŸ’¬ Chat with {{ other_user.username }}</h4>
        </div>
        <div class="card-body" id="chat-box" style="height: 300px; overflow-y: scroll;">
          <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºØ§Ø¯ÙŠ ØªØ·Ù„Ø¹ Ù‡Ù†Ø§ -->
        </div>
        <div class="card-footer">
          <form id="chat-form">
            <div class="input-group">
              <input type="text" id="chat-message-input" class="form-control" placeholder="Type your message...">
              <button class="btn btn-primary" type="submit">Send</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const otherUserId = "{{ other_user.id }}";
  const username = "{{ request.user.username }}";
  const chatBox = document.getElementById("chat-box");
  
  // Ø¥Ù†Ø´Ø§Ø¡ WebSocket Ù„Ù„ØºØ±ÙØ©
  const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/' + otherUserId + '/'
  );
  
  // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø¨Ø± WebSocket ÙˆØ¹Ø±Ø¶Ù‡Ø§
  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    chatBox.innerHTML += `<div><strong>${data.username}:</strong> ${data.message}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
  };
  
  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };
  
  // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† GraphQL Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  function fetchMessages() {
    fetch('/graphql/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
      },
      body: JSON.stringify({
        query: `
          query {
            messages(otherUserId: ${otherUserId}) {
              id
              content
              sender {
                username
              }
              timestamp
            }
          }
        `
      }),
    })
    .then(res => res.json())
    .then(res => {
      chatBox.innerHTML = '';
      res.data.messages.forEach(msg => {
        chatBox.innerHTML += `<div><strong>${msg.sender.username}:</strong> ${msg.content}</div>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }
  
  fetchMessages();
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± GraphQL mutation Ø«Ù… Ø¹Ø±Ø¶Ù‡Ø§ ÙÙˆØ±Ø§Ù‹ + Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ø¹Ø¨Ø± WebSocket
  document.getElementById("chat-form").onsubmit = function(e) {
    e.preventDefault();
    const messageInput = document.getElementById("chat-message-input");
    const message = messageInput.value.trim();
    if (!message) return;
  
    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹ ÙÙŠ DOM Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø¯
    // chatBox.innerHTML += `<div><strong>${username}:</strong> ${message}</div>`;
    // chatBox.scrollTop = chatBox.scrollHeight;
  
    fetch('/graphql/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
      },
      body: JSON.stringify({
        query: `
          mutation {
            sendMessage(receiverId: ${otherUserId}, content: "${message.replace(/"/g, '\\"')}") {
              message {
                id
                content
                sender {
                  username
                }
              }
            }
          }
        `
      }),
    })
    .then(res => res.json())
    .then(() => {
      chatSocket.send(JSON.stringify({
        message: message,
        username: username
      }));
      messageInput.value = "";
    })
    .catch(err => console.error('Error sending message:', err));
  };
  
  function getCSRFToken() {
    return document.cookie
      .split("; ")
      .find(row => row.startsWith("csrftoken="))
      .split("=")[1];
  }
  </script>
  
{% endblock %}
