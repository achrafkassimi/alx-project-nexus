{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <div class="row">
    <!-- Sidebar: Users List -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5>ðŸ“œ Users</h5>
        </div>
        <ul class="list-group list-group-flush">
          {% for user in users %}
          <a href="{% url 'chat_with_user' user.id %}"
             class="list-group-item list-group-item-action {% if user.id == other_user.id %}active{% endif %}">
            {{ user.username }}
          </a>
        {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Chat Interface -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h4>ðŸ’¬ Chat with 
            {% if other_user %}
              {{ other_user.username }}
            {% else %}
              (Select a user)
            {% endif %}
          </h4>
        </div>
        <div class="card-body" id="chat-box" style="height: 300px; overflow-y: scroll; background-color: #f8f9fa;">
          <!-- Messages will appear here -->
          {% if not other_user %}
            <p class="text-center text-muted mt-5">Select a user from the sidebar to start chatting</p>
          {% endif %}
        </div>
        {% if other_user %}
        <div class="card-footer">
          <form id="chat-form">
            <div class="input-group">
              <input type="text" id="chat-message-input" class="form-control" placeholder="Type your message...">
              <button class="btn btn-primary" type="submit">Send</button>
            </div>
          </form>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if other_user %}
<script>
  const otherUserId = "{{ other_user.id }}";
  const currentUsername = "{{ request.user.username }}";
  const chatBox = document.getElementById("chat-box");
  
  // Create WebSocket connection
  const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/' + otherUserId + '/'
  );
  
  // Handle incoming WebSocket messages
  chatSocket.onmessage = function(e) {
    console.log("Received WebSocket message:", e.data);
    const data = JSON.parse(e.data);
    
    // Add message to chat
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-2 p-2 rounded';
    
    // Style differently for current user vs other user
    if (data.sender === currentUsername) {
      messageDiv.className += ' bg-primary text-white ml-auto';
      messageDiv.style.maxWidth = '70%';
      messageDiv.style.marginLeft = 'auto';
      messageDiv.innerHTML = `<div><strong>You:</strong> ${data.message}</div><small>${data.timestamp || 'now'}</small>`;
    } else {
      messageDiv.className += ' bg-light';
      messageDiv.style.maxWidth = '70%';
      messageDiv.innerHTML = `<div><strong>${data.sender}:</strong> ${data.message}</div><small>${data.timestamp || 'now'}</small>`;
    }
    
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  };
  
  chatSocket.onopen = function(e) {
    console.log("WebSocket connection opened successfully");
  };
  
  chatSocket.onclose = function(e) {
    console.error('WebSocket connection closed:', e);
  };

  chatSocket.onerror = function(e) {
    console.error("WebSocket error:", e);
  };

  // Fetch existing messages from GraphQL when page loads
  function fetchMessages() {
    fetch('/graphql/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
      },
      body: JSON.stringify({
        query: `
          query {
            messages(otherUserId: ${otherUserId}) {
              id
              content
              sender {
                username
              }
              timestamp
            }
          }
        `
      }),
    })
    .then(res => res.json())
    .then(res => {
      console.log("Fetched messages:", res.data);
      chatBox.innerHTML = '';
      
      if (res.data && res.data.messages) {
        res.data.messages.forEach(msg => {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'mb-2 p-2 rounded';
          
          if (msg.sender.username === currentUsername) {
            messageDiv.className += ' bg-primary text-white ml-auto';
            messageDiv.style.maxWidth = '70%';
            messageDiv.style.marginLeft = 'auto';
            messageDiv.innerHTML = `<div><strong>You:</strong> ${msg.content}</div><small>${new Date(msg.timestamp).toLocaleTimeString()}</small>`;
          } else {
            messageDiv.className += ' bg-light';
            messageDiv.style.maxWidth = '70%';
            messageDiv.innerHTML = `<div><strong>${msg.sender.username}:</strong> ${msg.content}</div><small>${new Date(msg.timestamp).toLocaleTimeString()}</small>`;
          }
          
          chatBox.appendChild(messageDiv);
        });
      }
      
      chatBox.scrollTop = chatBox.scrollHeight;
    })
    .catch(err => {
      console.error('Error fetching messages:', err);
      chatBox.innerHTML = '<p class="text-danger">Error loading messages</p>';
    });
  }
  
  // Load messages on page load
  fetchMessages();
  
  // Handle form submission - send via WebSocket only
  document.getElementById("chat-form").onsubmit = function(e) {
    e.preventDefault();
    const messageInput = document.getElementById("chat-message-input");
    const message = messageInput.value.trim();
    if (!message) return;

    console.log("Sending message via WebSocket:", message);

    // Send directly via WebSocket
    if (chatSocket.readyState === WebSocket.OPEN) {
      chatSocket.send(JSON.stringify({
        message: message,
      }));
      messageInput.value = "";
    } else {
      console.warn("WebSocket not ready, state:", chatSocket.readyState);
      alert("Connection not ready. Please try again.");
    }
  };
  
  function getCSRFToken() {
    const cookieValue = document.cookie
      .split('; ')
      .find(row => row.startsWith('csrftoken='));
    return cookieValue ? cookieValue.split('=')[1] : null;
  }
</script>
{% endif %}

{% endblock %}